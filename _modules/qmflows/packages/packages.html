
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>qmflows.packages.packages &#8212; qmflows 1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for qmflows.packages.packages</h1><div class="highlight"><pre>
<span></span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import_parser&#39;</span><span class="p">,</span> <span class="s1">&#39;package_properties&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Package&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;registry&#39;</span><span class="p">,</span> <span class="s1">&#39;Result&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SerMolecule&#39;</span><span class="p">,</span> <span class="s1">&#39;SerSettings&#39;</span><span class="p">]</span>


<span class="c1"># ========&gt;  Standard and third party Python Libraries &lt;======</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="k">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">scm</span> <span class="k">import</span> <span class="n">plams</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span> <span class="k">as</span> <span class="nn">pkg</span>

<span class="c1"># ==================&gt; Internal modules &lt;====================</span>
<span class="kn">from</span> <span class="nn">noodles</span> <span class="k">import</span> <span class="p">(</span><span class="n">schedule_hint</span><span class="p">,</span> <span class="n">has_scheduled_methods</span><span class="p">,</span> <span class="n">serial</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">noodles.display</span> <span class="k">import</span> <span class="p">(</span><span class="n">NCDisplay</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">noodles.files.path</span> <span class="k">import</span> <span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="n">SerPath</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">noodles.run.run_with_prov</span> <span class="k">import</span> <span class="n">run_parallel_opt</span>
<span class="kn">from</span> <span class="nn">noodles.serial</span> <span class="k">import</span> <span class="p">(</span><span class="n">Serialiser</span><span class="p">,</span> <span class="n">Registry</span><span class="p">,</span> <span class="n">AsDict</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">noodles.serial.base</span> <span class="k">import</span> <span class="n">SerStorable</span>
<span class="c1"># from noodles.run.xenon import (</span>
<span class="c1">#     XenonKeeper, XenonConfig, RemoteJobConfig, run_xenon_prov)</span>
<span class="kn">from</span> <span class="nn">noodles.serial.numpy</span> <span class="k">import</span> <span class="n">arrays_to_hdf5</span>

<span class="kn">from</span> <span class="nn">qmflows.settings</span> <span class="k">import</span> <span class="n">Settings</span>
<span class="kn">from</span> <span class="nn">qmflows</span> <span class="k">import</span> <span class="n">molkit</span>
<span class="kn">from</span> <span class="nn">qmflows.fileFunctions</span> <span class="k">import</span> <span class="n">json2Settings</span>
<span class="kn">from</span> <span class="nn">qmflows.utils</span> <span class="k">import</span> <span class="n">concatMap</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>

<span class="n">package_properties</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;adf&#39;</span><span class="p">:</span> <span class="s1">&#39;data/dictionaries/propertiesADF.json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dftb&#39;</span><span class="p">:</span> <span class="s1">&#39;data/dictionaries/propertiesDFTB.json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cp2k&#39;</span><span class="p">:</span> <span class="s1">&#39;data/dictionaries/propertiesCP2K.json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dirac&#39;</span><span class="p">:</span> <span class="s1">&#39;data/dictionaries/propertiesDIRAC.json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gamess&#39;</span><span class="p">:</span> <span class="s1">&#39;data/dictionaries/propertiesGAMESS.json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;orca&#39;</span><span class="p">:</span> <span class="s1">&#39;data/dictionaries/propertiesORCA.json&#39;</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">Result</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class containing the result associated with a quantum chemistry simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">plams_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="n">warnings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param settings: Job Settings.</span>
<span class="sd">        :type settings: :class:`~qmflows.Settings`</span>
<span class="sd">        :param molecule: molecular Geometry</span>
<span class="sd">        :type molecule: plams Molecule</span>
<span class="sd">        :param job_name: Name of the computations</span>
<span class="sd">        :type job_name: str</span>
<span class="sd">        :param plams_dir: path to the ``Plams`` folder.</span>
<span class="sd">        :type plams_dir: str</span>
<span class="sd">        :param work_dir: scratch or another directory different from</span>
<span class="sd">        the `plams_dir`.</span>
<span class="sd">        type work_dir: str</span>
<span class="sd">        :param properties: path to the `JSON` file containing the data to</span>
<span class="sd">                           load the parser on the fly.</span>
<span class="sd">        :type properties: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span> <span class="o">=</span> <span class="n">molecule</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">resource_string</span><span class="p">(</span><span class="s2">&quot;qmflows&quot;</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span> <span class="o">=</span> <span class="n">json2Settings</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">archive</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;plams_dir&quot;</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">plams_dir</span><span class="p">),</span>
                        <span class="s1">&#39;work_dir&#39;</span><span class="p">:</span> <span class="n">work_dir</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="n">warnings</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span>
                      <span class="n">plams_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">[</span><span class="s1">&#39;plams_dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                      <span class="n">work_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">],</span>
                      <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                      <span class="n">warnings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span>
                      <span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to serialize as a JSON dictionary the results given</span>
<span class="sd">        by an ``Package`` computation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;settings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
            <span class="s2">&quot;molecule&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_molecule</span><span class="p">,</span>
            <span class="s2">&quot;job_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span>
            <span class="s2">&quot;archive&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span>
                  <span class="n">status</span><span class="p">,</span> <span class="n">warnings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Methods to deserialize an `Result`` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a section of the results.</span>

<span class="sd">        Example:</span>

<span class="sd">        ..</span>
<span class="sd">            dipole = result.dipole</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crash_status</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;crashed&#39;</span><span class="p">]</span>
        <span class="n">is_private</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prop</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span>
        <span class="c1"># if self.status == &#39;successful&#39;:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crash_status</span> <span class="ow">and</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crash_status</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_private</span> <span class="ow">and</span>
              <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Generic property &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39; not defined&quot;</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">crash_status</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_private</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            It is not possible to retrieve property: &#39;</span><span class="si">{}</span><span class="s2">&#39;</span>
<span class="s2">            Because Job: &#39;</span><span class="si">{}</span><span class="s2">&#39; has failed. Check the output.</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">            Are you sure that you have the package installed or</span>
<span class="s2">             you have loaded the package in the cluster. For example:</span>
<span class="s2">            `module load AwesomeQuantumPackage/3.141592`</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look for the optional arguments to parse a property, which are stored</span>
<span class="sd">        in the properties dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read the JSON dictionary than contains the parsers names</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prop_dict</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>

        <span class="c1"># extension of the output file containing the property value</span>
        <span class="n">file_ext</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;file_ext&#39;</span><span class="p">]</span>

        <span class="c1"># If there is not work_dir returns None</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;work_dir&#39;</span><span class="p">)</span>

        <span class="c1"># Plams dir</span>
        <span class="n">plams_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive</span><span class="p">[</span><span class="s1">&#39;plams_dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>

        <span class="c1"># Search for the specified output file in the folders</span>
        <span class="n">file_pattern</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_pattern&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_pattern</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">*.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">file_ext</span><span class="p">)</span>

        <span class="n">output_files</span> <span class="o">=</span> <span class="n">concatMap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">find_file_pattern</span><span class="p">,</span> <span class="n">file_pattern</span><span class="p">),</span>
                                 <span class="p">[</span><span class="n">plams_dir</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">output_files</span><span class="p">:</span>
            <span class="n">file_out</span> <span class="o">=</span> <span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">import_parser</span><span class="p">(</span><span class="n">ds</span><span class="p">),</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">])</span>
            <span class="c1"># Read the keywords arguments from the properties dictionary</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plams_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plams_dir</span>
            <span class="k">return</span> <span class="n">ignored_unused_kwargs</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="p">[</span><span class="n">file_out</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Property </span><span class="si">{}</span><span class="s2"> not found. No output file called: </span><span class="si">{}</span><span class="s2">. Folder used:</span>
<span class="s2">            plams_dir = </span><span class="si">{}</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">            work_dir </span><span class="si">{}</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">file_pattern</span><span class="p">,</span> <span class="n">plams_dir</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<div class="viewcode-block" id="Package"><a class="viewcode-back" href="../../../packages.html#qmflows.packages.Package">[docs]</a><span class="nd">@has_scheduled_methods</span>
<span class="k">class</span> <span class="nc">Package</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    |Package| is the base class to handle the invocation to different</span>
<span class="sd">    quantum package.</span>
<span class="sd">    The only relevant attribute of this class is ``self.pkg_name`` which is a</span>
<span class="sd">    string representing the quantum package name that is going to be used to</span>
<span class="sd">    carry out the compuation.</span>

<span class="sd">    Only two arguments are required</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_name</span> <span class="o">=</span> <span class="n">pkg_name</span>

<div class="viewcode-block" id="Package.__call__"><a class="viewcode-back" href="../../../packages.html#qmflows.packages.Package.__call__">[docs]</a>    <span class="nd">@schedule_hint</span><span class="p">(</span>
        <span class="n">display</span><span class="o">=</span><span class="s2">&quot;Running </span><span class="si">{self.pkg_name}</span><span class="s2"> </span><span class="si">{job_name}</span><span class="s2">...&quot;</span><span class="p">,</span>
        <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function performs a job with the package specified by</span>
<span class="sd">        self.pkg_name</span>

<span class="sd">        :parameter settings: user settings</span>
<span class="sd">        :type settings: |Settings|</span>
<span class="sd">        :parameter mol: Molecule to run the calculation.</span>
<span class="sd">        :type mol: plams Molecule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="n">package_properties</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_name</span><span class="p">]</span>

        <span class="c1"># There are not data from previous nodes in the dependecy trees</span>
        <span class="c1"># because of a failure upstream or the user provided None as argument</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">settings</span><span class="p">,</span> <span class="n">mol</span><span class="p">]):</span>
            <span class="c1">#  Check if plams finishes normally</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If molecule is an RDKIT molecule translate it to plams</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="n">molkit</span><span class="o">.</span><span class="n">from_rdmol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">)</span> <span class="k">else</span> <span class="n">mol</span>

                <span class="k">if</span> <span class="n">job_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_name</span>

                <span class="c1"># Settings transformations</span>
                <span class="n">job_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic2specific</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>

                <span class="c1"># Run the job</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prerun</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">job_settings</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="c1"># Check if there are warnings in the output that render the calculation</span>
                <span class="c1"># useless from the point of view of the user</span>
                <span class="n">warnings_tolerance</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;terminate_job_in_case_of_warnings&quot;</span><span class="p">)</span>
                <span class="n">output_warnings</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">warnings</span>

                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="n">warnings_tolerance</span><span class="p">,</span> <span class="n">output_warnings</span><span class="p">]):</span>
                    <span class="n">issues</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">for</span> <span class="n">msg</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">output_warnings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                              <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warnings_tolerance</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">issues</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        The Following Warning are rendered unacceptable in the Current</span>
<span class="s2">                        Workflow: </span><span class="si">{}</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">                        The results from Job: </span><span class="si">{}</span><span class="s2"> are discarded.</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">issues</span><span class="p">,</span> <span class="n">job_name</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                                        <span class="n">status</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">)</span>

            <span class="c1"># Otherwise pass an empty Result instance downstream</span>
            <span class="k">except</span> <span class="n">plams</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">PlamsError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Job </span><span class="si">{}</span><span class="s2"> has failed.</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
                                <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">)</span>
            <span class="c1"># except Exception as e:</span>
            <span class="c1">#     print(&quot;Exception e: &quot;, type(e), e.args)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Job </span><span class="si">{}</span><span class="s2"> has failed. Either the Settings or Molecule</span>
<span class="s2">            objects are None, probably due to a previous calculation failure</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Send an empty object downstream</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Result</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
                            <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">)</span>

        <span class="c1"># Label this calculation as failed if there are not dependecies coming</span>
        <span class="c1"># from upstream</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">postrun</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Package.generic2specific"><a class="viewcode-back" href="../../../packages.html#qmflows.packages.Package.generic2specific">[docs]</a>    <span class="k">def</span> <span class="nf">generic2specific</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Traverse all the key, value pairs of the ``settings``, translating</span>
<span class="sd">        the generic keys into package specific keys as defined in the specific</span>
<span class="sd">        dictionary. If one key is not in the specific dictionary an error</span>
<span class="sd">        is raised. These new specific settings take preference over existing</span>
<span class="sd">        specific settings.</span>

<span class="sd">        :parameter settings: Settings provided by the user.</span>
<span class="sd">        :type      settings: Settings</span>
<span class="sd">        :parameter mol: Molecule to run the calculation.</span>
<span class="sd">        :type mol: plams Molecule</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">generic_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_generic_dict</span><span class="p">()</span>

        <span class="n">specific_from_generic_settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;specific&quot;</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">generic_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">v</span><span class="p">}</span>
                        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">specific_from_generic_settings</span> \
                            <span class="o">.</span><span class="n">specific</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">specific_from_generic_settings</span> \
                            <span class="o">.</span><span class="n">specific</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pkg_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_special_keywords</span><span class="p">(</span>
                        <span class="n">specific_from_generic_settings</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mol</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">specific_from_generic_settings</span><span class="p">)</span></div>

<div class="viewcode-block" id="Package.get_generic_dict"><a class="viewcode-back" href="../../../packages.html#qmflows.packages.Package.get_generic_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_generic_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the JSON file containing the translation from generic to</span>
<span class="sd">        the specific keywords of ``self.pkg_name``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;data/dictionaries&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_dict_file</span><span class="p">)</span>
        <span class="n">str_json</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">resource_string</span><span class="p">(</span><span class="s2">&quot;qmflows&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json2Settings</span><span class="p">(</span><span class="n">str_json</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_name</span>

<div class="viewcode-block" id="Package.handle_special_keywords"><a class="viewcode-back" href="../../../packages.html#qmflows.packages.Package.handle_special_keywords">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">handle_special_keywords</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method should be implemented by the child class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;trying to call an abstract method&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="Package.run_job"><a class="viewcode-back" href="../../../packages.html#qmflows.packages.Package.run_job">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">run_job</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method should be implemented by the child class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The class representing a given quantum packages should </span><span class="se">\</span>
<span class="s2">        implement this method&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pickup a runner and initialize it.</span>

<span class="sd">    :params job: computation to run</span>
<span class="sd">    :type job: Promise Object</span>
<span class="sd">    :param runner: Type of runner to use</span>
<span class="sd">    :type runner: String</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initialize</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">config</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="n">jm</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> \
                <span class="n">folder</span> <span class="ow">and</span> <span class="n">folder</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="n">jm</span><span class="o">.</span><span class="n">folder</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Reinitializing Plams with new path and/or folder name.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">plams</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="n">plams</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">plams</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">initialize</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">builtins</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">builtins</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">jobmanager</span><span class="o">.</span><span class="n">jobfolder_exists</span> <span class="o">=</span> <span class="s1">&#39;rename&#39;</span>
    <span class="k">if</span> <span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">call_default</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># elif runner.lower() == &#39;xenon&#39;:</span>
    <span class="c1">#     ret = call_xenon(job, **kwargs)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="s2">&quot;Don&#39;t know runner: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
        <span class="n">plams</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">call_default</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">n_processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;cache.json&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run locally using several threads.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">NCDisplay</span><span class="p">()</span> <span class="k">as</span> <span class="n">display</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">run_parallel_opt</span><span class="p">(</span>
            <span class="n">job</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=</span><span class="n">n_processes</span><span class="p">,</span>
            <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">,</span> <span class="n">jobdb_file</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
            <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">)</span>


<span class="c1"># def call_xenon(job, n_processes=1, cache=&#39;cache.json&#39;, user_name=None, adapter=&#39;slurm&#39;,</span>
<span class="c1">#                queue_name=None, host_name=None, workdir=None, timeout=60000, **kwargs):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     See :</span>
<span class="c1">#         https://github.com/NLeSC/Xenon-examples/raw/master/doc/tutorial/xenon-tutorial.pdf</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     dict_properties = {</span>
<span class="c1">#         &#39;slurm&#39;: {&#39;xenon.adaptors.slurm.ignore.version&#39;: &#39;true&#39;},</span>
<span class="c1">#         &#39;pbs&#39;: {&#39;xenon.adaptors.pbs.ignore.version&#39;: &#39;true&#39;}</span>
<span class="c1">#     }</span>
<span class="c1">#     with XenonKeeper(log_level=&#39;DEBUG&#39;) as Xe:</span>
<span class="c1">#         certificate = Xe.credentials.newCertificateCredential(</span>
<span class="c1">#             &#39;ssh&#39;, os.environ[&quot;HOME&quot;] + &#39;/.ssh/id_rsa&#39;, user_name, &#39;&#39;, None)</span>

<span class="c1">#         xenon_config = XenonConfig(</span>
<span class="c1">#             jobs_scheme=adapter,</span>
<span class="c1">#             location=host_name,</span>
<span class="c1">#             credential=certificate,</span>
<span class="c1">#             jobs_properties=dict_properties[adapter]</span>
<span class="c1">#         )</span>
<span class="c1">#         print(xenon_config.__dict__)</span>

<span class="c1">#         if workdir is None:</span>
<span class="c1">#             workdir = &#39;/home/&#39; + user_name</span>

<span class="c1">#         job_config = RemoteJobConfig(</span>
<span class="c1">#             registry=registry,</span>
<span class="c1">#             init=plams.init,</span>
<span class="c1">#             finish=plams.finish,</span>
<span class="c1">#             queue=queue_name,</span>
<span class="c1">#             time_out=timeout,</span>
<span class="c1">#             working_dir=workdir</span>
<span class="c1">#         )</span>

<span class="c1">#         with NCDisplay() as display:</span>
<span class="c1">#             result = run_xenon_prov(</span>
<span class="c1">#                 job, Xe, cache, n_processes,</span>
<span class="c1">#                 xenon_config, job_config, display=display)</span>

<span class="c1">#     return result</span>


<span class="k">class</span> <span class="nc">SerMolecule</span><span class="p">(</span><span class="n">Serialiser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Based on the Plams molecule this class encode and decode the</span>
<span class="sd">    information related to the molecule using the JSON format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SerMolecule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">make_rec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">make_rec</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SerMol</span><span class="p">(</span><span class="n">Serialiser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Based on the RDKit molecule this class encodes and decodes the</span>
<span class="sd">    information related to the molecule using a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SerMol</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">make_rec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">make_rec</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ToBinary</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">SerSettings</span><span class="p">(</span><span class="n">Serialiser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to encode and decode the ~qmflows.Settings class using</span>
<span class="sd">    its internal dictionary structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SerSettings</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">Settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">make_rec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">make_rec</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Settings</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">registry</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function pass to the noodles infrascture all the information</span>
<span class="sd">    related to the Structure of the Package object that is schedule.</span>
<span class="sd">    This *Registry* class contains hints that help Noodles to encode</span>
<span class="sd">    and decode this Package object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Registry</span><span class="p">(</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">base</span><span class="p">()</span> <span class="o">+</span> <span class="n">arrays_to_hdf5</span><span class="p">(),</span>
        <span class="n">types</span><span class="o">=</span><span class="p">{</span>
            <span class="n">Package</span><span class="p">:</span> <span class="n">AsDict</span><span class="p">(</span><span class="n">Package</span><span class="p">),</span>
            <span class="n">Path</span><span class="p">:</span> <span class="n">SerPath</span><span class="p">(),</span>
            <span class="n">plams</span><span class="o">.</span><span class="n">Molecule</span><span class="p">:</span> <span class="n">SerMolecule</span><span class="p">(),</span>
            <span class="n">Chem</span><span class="o">.</span><span class="n">Mol</span><span class="p">:</span> <span class="n">SerMol</span><span class="p">(),</span>
            <span class="n">Result</span><span class="p">:</span> <span class="n">SerStorable</span><span class="p">(</span><span class="n">Result</span><span class="p">),</span>
            <span class="n">Settings</span><span class="p">:</span> <span class="n">SerSettings</span><span class="p">()})</span>


<span class="k">def</span> <span class="nf">import_parser</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">module_root</span><span class="o">=</span><span class="s2">&quot;qmflows.parsers&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Import parser for the corresponding property.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module_sufix</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;parser&#39;</span><span class="p">]</span>
    <span class="n">module_name</span> <span class="o">=</span> <span class="n">module_root</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">module_sufix</span>

    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_file_pattern</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
                   <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">),</span> <span class="n">pat</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">get_tmpfile_name</span><span class="p">():</span>
    <span class="n">tmpfolder</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">jm</span><span class="o">.</span><span class="n">workdir</span> <span class="o">+</span> <span class="s1">&#39;/tmpfiles&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmpfolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmpfolder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tmpfolder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">ignored_unused_kwargs</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect the signature of function `fun` and filter the keyword arguments,</span>
<span class="sd">    which are the ones that have a nonempty default value. Then extract</span>
<span class="sd">    from the dict `kwargs` those key-value pairs ignoring the rest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>

    <span class="c1"># Look for the arguments with the nonempty defaults.</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">,</span>
                           <span class="n">ps</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="c1"># there are not keyword arguments in the function</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">defaults</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># extract from kwargs only the used keyword arguments</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_output_warnings</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">plams_dir</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">package_warnings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look out for warnings in the output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">find_file_pattern</span><span class="p">(</span><span class="s1">&#39;*out&#39;</span><span class="p">,</span> <span class="n">plams_dir</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_files</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;job: </span><span class="si">{}</span><span class="s2"> has failed. check folder: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">plams_dir</span><span class="p">)</span>
        <span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">output_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">package_warnings</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">qmflows</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../includeme.html">QMFlows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interactive_tutorial.html">Basic usage tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Library Documentation</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, F. Zapata, L. Ridder.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>